<?php
/***********************************************
-=Ms Site=-

Автор:    Миропольский Михаил <ms@ensk.ru>
Описание: Класс картинки подтверждения
***********************************************/

class Confirm
{
	var $cipherArray = array(
					'~' => '1',
				   	'`' => '2',
					'!' => '3',
					'@' => '4',
					'#' => '5',
					'$' => '6',
					'%' => '7',
					'^' => '8',
					'&' => '9',
					'*' => '10',
					'(' => '11',
					')' => '12',
					'_' => '13',
					'-' => '14',
					'+' => '15',
					'|' => '16',
 					"\\" => '17',
 					'/' => '18',
					'.' => '19',
					',' => '20',
					'?' => '21',
					':' => '22',
					';' => '23',
					"'" => '24',
					'"' => '25',
					' ' => '26',
					'{' => '27',
					'}' => '28',
					'[' => '29',
					']' => '30',
					"\a" => '30',
					"\e" => '30',
					"\f" => '30',
					"\n" => '30',
					"\r" => '30',
					"\t" => '30',
					"\r" => '32',
					'0' => '100',
					'1' => '101',
					'2' => '102',
					'3' => '103',
					'4' => '104',
					'5' => '105',
					'6' => '106',
					'7' => '107',
					'8' => '108',
					'9' => '109',
					'a' => '201',
					'b' => '202',
					'c' => '203',
					'd' => '204',
					'e' => '205',
					'f' => '206',
					'g' => '207',
					'h' => '208',
					'i' => '209',
					'j' => '210',
					'k' => '211',
					'l' => '212',
					'm' => '213',
					'n' => '214',
					'o' => '215',
					'p' => '216',
					'q' => '217',
					'r' => '218',
					's' => '219',
					't' => '220',
					'u' => '221',
					'v' => '222',
					'w' => '223',
					'x' => '224',
					'y' => '225',
					'z' => '226',
					'A' => '301',
					'B' => '302',
					'C' => '303',
					'D' => '304',
					'E' => '305',
					'F' => '306',
					'G' => '307',
					'H' => '308',
					'I' => '309',
					'J' => '310',
					'K' => '311',
					'L' => '312',
					'M' => '313',
					'N' => '314',
					'O' => '315',
					'P' => '316',
					'Q' => '317',
					'R' => '318',
					'S' => '319',
					'T' => '320',
					'U' => '321',
					'V' => '322',
					'W' => '323',
					'X' => '324',
					'Y' => '325',
					'Z' => '326',
					'а' => '401',
					'б' => '402',
					'в' => '403',
					'г' => '404',
					'д' => '405',
					'е' => '406',
					'ё' => '407',
					'ж' => '408',
					'з' => '409',
					'и' => '410',
					'й' => '411',
					'к' => '412',
					'л' => '413',
					'м' => '414',
					'н' => '415',
					'о' => '416',
					'п' => '417',
					'р' => '418',
					'с' => '419',
					'т' => '420',
					'у' => '421',
					'ф' => '422',
					'х' => '423',
					'ц' => '424',
					'ч' => '425',
					'ш' => '426',
					'щ' => '427',
					'ъ' => '428',
					'ы' => '429',
					'ь' => '430',
					'э' => '431',
					'ю' => '432',
					'я' => '433',
					'А' => '501',
					'Б' => '502',
					'В' => '503',
					'Г' => '504',
					'Д' => '505',
					'Е' => '506',
					'Ё' => '507',
					'Ж' => '508',
					'З' => '509',
					'И' => '510',
					'Й' => '511',
					'К' => '512',
					'Л' => '513',
					'М' => '514',
					'Н' => '515',
					'О' => '516',
					'П' => '517',
					'Р' => '518',
					'С' => '519',
					'Т' => '520',
					'У' => '521',
					'Ф' => '522',
					'Х' => '523',
					'Ц' => '524',
					'Ч' => '525',
					'Ш' => '526',
					'Щ' => '527',
					'Ъ' => '528',
					'Ы' => '529',
					'Ь' => '530',
					'Э' => '531',
					'Ю' => '532',
					'Я' => '533'
					);
					
	var $ERROR = '';
	var $CODE = '';
	var $CIPHER = '';

	function ConvertString2Array($string, $num)
	{
		$temp = $string;
		for ($i = 0; $i < strlen($string)/$num; $i++)
		{
			$string_array[$i]=substr($temp, 0, $num);
			$temp = substr($temp, $num);
		}
		return $string_array;
	}
					
	function CipherEncode($string)
	{
		//source string to array
		$string_array = self::ConvertString2Array($string, 1);

		//generate key
		$codekey = rand(1000, 9000);

		//encode as in table
		foreach ($string_array as $key => $char)
		{
			if ( !isset($this->cipherArray[$char]) ) $char = '?';
			$string_array[$key] = $this->cipherArray[$char] + $codekey;
		}

		//merge
		$code = implode("", $string_array);

		//mix
		$pieces = self::ConvertString2Array($code, 10);
		foreach ($pieces as $key => $piece_string)
		{
			if ( strlen($piece_string) != 10 ) break;

			$source = self::ConvertString2Array($piece_string, 1);
			$result[0] = $source[4];
			$result[1] = $source[9];
			$result[2] = $source[5];
			$result[3] = $source[1];
			$result[4] = $source[0];
			$result[5] = $source[7];
			$result[6] = $source[3];
			$result[7] = $source[2];
			$result[8] = $source[6];
			$result[9] = $source[8];

			$pieces[$key] = implode('', $result);
		}
		$code = implode('', $pieces);


		//add key
		$code = $codekey . $code;

		return $code;
	}


	function CipherDecode($code)
	{
		$cipherArray = array_flip($this->cipherArray);

		//get key
		$codekey = substr($code, 0, 4);

		$string = substr( $code, 4 );

		//remix
		$pieces = self::ConvertString2Array($string, 10);
		
		foreach ($pieces as $key => $piece_string)
		{
			if ( strlen($piece_string) != 10 ) break;

			$result = self::ConvertString2Array($piece_string, 1);
			$source[0] = $result[4];
			$source[1] = $result[3];
			$source[2] = $result[7];
			$source[3] = $result[6];
			$source[4] = $result[0];
			$source[5] = $result[2];
			$source[6] = $result[8];
			$source[7] = $result[5];
			$source[8] = $result[9];
			$source[9] = $result[1];

			$pieces[$key] = implode('', $source);
		}
		$string = implode('', $pieces);

		//encoded string to array
		$code_array = self::ConvertString2Array($string, 4);

		//decode as in table
		foreach ($code_array as $key => $code_array_char)
		{
			$temp = $code_array_char - $codekey;
			$code_array[$key] = $cipherArray[$temp];
		}

		//merge
		$string = implode("", $code_array);


		return $string;
	}
	
	function ConfirmGenerateImage($code)
	{
		$diagramWidth = 40;
		$diagramHeight = 15;

		$image = imageCreateTrueColor ($diagramWidth, $diagramHeight);

		$imagebg = imageCreateFromPNG ('images/confirm.png'); // transparent PNG
	   	$imagebg = imagerotate ( $imagebg, rand(0, 3)*90, 0);

		imageSetTile ($image, $imagebg);
		imageFilledRectangle ($image, 0, 0, $diagramWidth, $diagramHeight, IMG_COLOR_TILED);

		$textcolor = imageColorAllocate ($image, 0, 0, 0);
		imageString ($image, 5, 3, 0, $code, $textcolor);

		Header("Content-type: image/png");
		imagePNG ($image);

		imagedestroy ($image);
		imagedestroy ($imagebg);
	}	
	
	function ConfirmView()
	{
		$cipher = self::CipherEncode(rand(1000, 9999));
		
		echo '<label><span class="error">*</span> Введите код подтверждения:</label>';
		echo '<img src="/confirm.php?code=' . $cipher . '" alt="" class="border" align="top"/> ';
		echo '<input name="code" type="text" maxlength="4" value="" class="autowidth"/>';
		if ($this->ERROR != '') echo '<div class="error">' . $this->ERROR . '</div>';
		echo '<input name="cipher" type="hidden" value="' . $cipher . '" />';
		
		return TRUE;
	}
	
	function ConfirmValidate()
	{
		if ( isset($_POST['code']) && isset($_POST['cipher']) && preg_match('/\d{4}/', $_POST['code']) )
		{
			$this->CODE = $_POST['code'];
			$this->CIPHER = $_POST['cipher'];
		}
		
		if ( $this->CODE == '' || $this->CODE != self::CipherDecode($this->CIPHER) )
		{
			$this->ERROR = 'Введите правильный код подтверждения';
			return FALSE;
		}
		return TRUE;
	}
}
?>